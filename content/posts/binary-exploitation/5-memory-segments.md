---
title: "Binary Exploitation 5: Memory Layout"
date: 2024-10-20T00:00:00+02:00
draft: false
tags:
  - binary exploitation
---

When we program in C, the memory layout of a program usually consists of few main segments, that represent different areas of memory used for different purposes when we run a program.

- **Text Segment** (Code Segment): is a read-only segment that stores machine code of the program. The segment is usually shared between multiple processes in the same execution of a program.

- **Initialized Data Segment** (Data Segment): is used to store global and static variables, as well as constant data that have an explicit initial value.

- **Uninitialized Data Segment** (BSS Segment): is used to store global and static variables that are uninitialized in source code or are set to 0. These variables are all set to 0 by the kernel before the program starts.

- **Heap**: is an area of dynamic memory used for dynamic memory allocation. It is manually allocated and deallocated during runtime. It grows from bss segment to higher addresses.

- **Stack**: is an area of dynamic memory used for automatic memory allocation. Each time a function is called, a new stack frame is created to store its local variables and function parameters. The stack grows and shrinks automatically as functions are called and return. It grows from higher to lower addresses.

When programming we have multiple options on where to put the variables: on stack, to heap or into static data (Data or BSS Segment).
The decision can be made based on the following differences:

**Stack**:
- Dynamic size
- Limited to small sizes
- Live span just in function

**Heap**:
- Dynamic size
- Can be large in size
- Live span across whole exectution

**Static**:
- Fixed size
- Can be large in size
- Live span accross whole exectution

Memory visualization of a running program is below:
```
                  +---------------------+
                 /| cmd line arguments, |
                / | environment vars    |
               /  +---------------------+
              /   | stack               |
RAM          /    +---------------------+
+---------+ /     |                     |
|         |/      |                     |
|+-------+|       +---------------------+
||program||       | heap                |
|+-------+|       +---------------------+
|         |\      | bss                 |
+---------+ \     +---------------------+
             \    | data                |
              \   +---------------------+
               \  | text                |
                \ |                     |
                 \|                     |
                  +---------------------+             

```

Example program in C that uses all described options
```C
#include<stdio.h>
#include<stdlib.h>

int var1[10]; // Global static variable

int main()
{
  int var2[10]; // Variable on stack

  static int var3[20]; // Static variable

  int *var4;  // Pointer variable saved on stack

  // Allocated 30 times size of int space on heap, it returns address of this space
  var4 = (int *)malloc(30*sizeof(int)); 

  // The space is uninitialized, we get random data!
  for (int i=0; i<30; i++)
  {
    printf("%d\n", var4[i]);
  }

  // We must manually release space on heap, when no longer needed to prevent memory leaks
  free(var4);

  return 0;
}
```
